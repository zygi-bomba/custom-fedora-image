# /etc/justfile

# Inicjalizacja ≈õrodowiska: klonuje repozytorium i bezpiecznie linkuje pliki
init-dots:
    #!/bin/bash
    # --- KONFIGURACJA ---
    DOTS_URL="https://github.com/zygi-bomba/dotfiles.git"
    DOTS_DIR="$HOME/dotfiles"
    BACKUP_DIR="$HOME/dotfiles_backup/$(date +%Y%m%d_%H%M%S)"

    echo "üöÄ Rozpoczynam inicjalizacjƒô dotfiles..."

    # 1. Klonowanie repozytorium (je≈õli nie istnieje)
    if [ ! -d "$DOTS_DIR" ]; then
        echo "üì• Klonujƒô repozytorium do $DOTS_DIR..."
        git clone "$DOTS_URL" "$DOTS_DIR"
    else
        echo "‚úÖ Repozytorium ju≈º istnieje, pobieram najnowsze zmiany..."
        cd "$DOTS_DIR" && git pull
    fi

    # 2. Tworzenie folderu na kopie zapasowe
    mkdir -p "$BACKUP_DIR"

    # 3. Inteligentne linkowanie z backupem
    cd "$DOTS_DIR"
    # Szukamy tylko folder√≥w (naszych pakiet√≥w jak niri, bash, nvim)
    for pkg in */; do
        pkg=${pkg%/} # Usuwamy uko≈õnik z nazwy
        
        echo "üì¶ Przetwarzam pakiet: $pkg"

        # Dla ka≈ºdego pakietu sprawdzamy, co stow by zlinkowa≈Ç
        # i je≈õli w $HOME jest tam PRAWDZIWY plik/folder, przenosimy go do backupu
        stow -nv -t "$HOME" "$pkg" 2>&1 | grep "existing target is not owned by stow" | awk '{print $NF}' | while read -r conflict; do
            FULL_PATH="$HOME/$conflict"
            if [ -e "$FULL_PATH" ] && [ ! -L "$FULL_PATH" ]; then
                echo "‚ö†Ô∏è  Backup: $conflict -> $BACKUP_DIR/"
                mkdir -p "$(dirname "$BACKUP_DIR/$conflict")"
                mv "$FULL_PATH" "$BACKUP_DIR/$conflict"
            fi
        done

        # 4. Finalne wywo≈Çanie STOW (teraz bez konflikt√≥w)
        stow -R -t "$HOME" "$pkg"
    done
    mkdir -p "$HOME/.config"
    touch "$HOME/.config/.dots-initialized"
    echo "‚ú® Gotowe! Twoje dotfiles sƒÖ aktywne."
    echo "üìÅ Kopie zapasowe starych plik√≥w znajdziesz w: $BACKUP_DIR"
