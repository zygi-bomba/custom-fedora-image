# /etc/justfile

# Inicjalizacja ≈õrodowiska: klonuje repozytorium i bezpiecznie linkuje pliki
init-dots:
    #!/bin/bash
    set -euo pipefail

    # --- KONFIGURACJA ---
    DOTS_URL="https://github.com/zygi-bomba/dotfiles.git"
    DOTS_DIR="$HOME/dotfiles"
    BACKUP_DIR="$HOME/dotfiles_backup/$(date +%Y%m%d_%H%M%S)"

    echo "üöÄ Rozpoczynam inicjalizacjƒô dotfiles..."

    # 1. Przygotowanie repozytorium
    if [ ! -d "$DOTS_DIR" ]; then
        echo "üì• Klonujƒô repozytorium do $DOTS_DIR..."
        git clone "$DOTS_URL" "$DOTS_DIR"
    else
        echo "‚úÖ Repozytorium istnieje, aktualizujƒô..."
        git -C "$DOTS_DIR" pull
    fi

    # 2. Tworzenie niezbƒôdnych folder√≥w
    mkdir -p "$BACKUP_DIR"
    mkdir -p "$HOME/.config"

    cd "$DOTS_DIR"

    # 3. Inteligentne linkowanie z backupem
    # Szukamy folder√≥w, kt√≥re nie sƒÖ ukryte (omijamy .git)
    for pkg in */; do
        pkg=${pkg%/}
        [ "$pkg" == ".git" ] && continue
        
        echo "üì¶ Przetwarzam pakiet: $pkg"

        # Wykrywanie konflikt√≥w przez dry-run
        # Przekierowujemy stderr do stdout (2>&1), aby grep go widzia≈Ç
        CONFLICTS=$(stow -nv -t "$HOME" "$pkg" 2>&1 | grep "existing target is not owned by stow" | awk '{print $NF}' || true)

        if [ -n "$CONFLICTS" ]; then
            for conflict in $CONFLICTS; do
                FULL_PATH="$HOME/$conflict"
                if [ -e "$FULL_PATH" ] || [ -L "$FULL_PATH" ]; then
                    echo "‚ö†Ô∏è  Backup: $conflict -> $BACKUP_DIR/"
                    mkdir -p "$(dirname "$BACKUP_DIR/$conflict")"
                    mv "$FULL_PATH" "$BACKUP_DIR/$conflict"
                fi
            done
        fi

        # 4. Finalne wywo≈Çanie STOW
        # -R (restow) jest bezpieczniejsze przy ponownym uruchamianiu
        stow -R -v -t "$HOME" "$pkg"
    done

    echo "‚ú® Gotowe! Twoje dotfiles sƒÖ aktywne."
    echo "üìÅ Kopie zapasowe starych plik√≥w znajdziesz w: $BACKUP_DIR"

# Pokazuje status dotfiles i narzƒôdzi
status:
    #!/bin/bash
    set -euo pipefail
    
    echo "üìä Status dotfiles i narzƒôdzi"
    echo ""
    
    # Sprawdzenie repo dotfiles
    if [ -d "$HOME/dotfiles" ]; then
        echo "‚úÖ Repozytorium dotfiles: $HOME/dotfiles"
        cd "$HOME/dotfiles"
        echo "   Branch: $(git branch --show-current)"
        echo "   Ostatni commit: $(git log -1 --pretty=format:'%h - %s')"
    else
        echo "‚ùå Brak repozytorium dotfiles"
    fi
    
    echo ""
    
    # Sprawdzenie narzƒôdzi
    echo "üîß Zainstalowane narzƒôdzia:"
    for tool in nvim starship zoxide atuin fzf bat eza git-delta lazygit; do
        if command -v $tool &> /dev/null; then
            version=$(command $tool --version 2>/dev/null | head -n1 || echo "zainstalowany")
            echo "   ‚úÖ $tool - $version"
        else
            echo "   ‚ùå $tool - brak"
        fi
    done

# Aktualizuje dotfiles z GitHub
update-dots:
    #!/bin/bash
    set -euo pipefail
    
    DOTS_DIR="$HOME/dotfiles"
    
    if [ ! -d "$DOTS_DIR" ]; then
        echo "‚ùå Repozytorium dotfiles nie istnieje. Uruchom najpierw 'jg init-dots'"
        exit 1
    fi
    
    echo "üîÑ Aktualizujƒô dotfiles..."
    cd "$DOTS_DIR"
    git pull
    
    echo "üîó Restow wszystkich pakiet√≥w..."
    for pkg in */; do
        pkg=${pkg%/}
        [ "$pkg" == ".git" ] && continue
        echo "   Restow: $pkg"
        stow -R -v -t "$HOME" "$pkg"
    done
    
    echo "‚ú® Aktualizacja zako≈Ñczona!"

# Inicjalizuje LazyVim
setup-lazyvim:
    #!/bin/bash
    set -euo pipefail
    
    NVIM_CONFIG="$HOME/.config/nvim"
    BACKUP_DIR="$HOME/.config/nvim.backup.$(date +%Y%m%d_%H%M%S)"
    
    echo "üöÄ Instalujƒô LazyVim..."
    
    # Backup istniejƒÖcej konfiguracji
    if [ -d "$NVIM_CONFIG" ]; then
        echo "üì¶ Backup istniejƒÖcej konfiguracji do $BACKUP_DIR"
        mv "$NVIM_CONFIG" "$BACKUP_DIR"
    fi
    
    # Klonowanie LazyVim starter
    echo "üì• Klonujƒô LazyVim starter..."
    git clone https://github.com/LazyVim/starter "$NVIM_CONFIG"
    rm -rf "$NVIM_CONFIG/.git"
    
    echo "‚ú® LazyVim zainstalowany! Uruchom 'nvim' aby doko≈Ñczyƒá instalacjƒô."
    echo "üí° Twoja stara konfiguracja: $BACKUP_DIR"

# Inicjalizuje atuin (historia polece≈Ñ)
setup-atuin:
    #!/bin/bash
    set -euo pipefail
    
    echo "üöÄ Inicjalizujƒô atuin..."
    
    if ! command -v atuin &> /dev/null; then
        echo "‚ùå atuin nie jest zainstalowany"
        exit 1
    fi
    
    # Import historii bash
    if [ -f "$HOME/.bash_history" ]; then
        echo "üì• Importujƒô historiƒô bash..."
        atuin import auto
    fi
    
    echo "‚ú® Atuin skonfigurowany!"
    echo "üí° Uruchom ponownie terminal lub 'source ~/.bashrc'"

# Kompletny setup wszystkiego
setup-all:
    #!/bin/bash
    set -euo pipefail
    
    echo "üöÄ Pe≈Çna inicjalizacja ≈õrodowiska..."
    echo ""
    
    just --justfile /etc/justfile --working-directory ~ init-dots
    echo ""
    just --justfile /etc/justfile --working-directory ~ setup-lazyvim
    echo ""
    just --justfile /etc/justfile --working-directory ~ setup-atuin
    echo ""
    just --justfile /etc/justfile --working-directory ~ status
    
    echo ""
    echo "‚ú® Wszystko gotowe! Uruchom ponownie terminal."

# Czy≈õci stare backupy (starsze ni≈º 30 dni)
cleanup-backups:
    #!/bin/bash
    set -euo pipefail
    
    BACKUP_BASE="$HOME/dotfiles_backup"
    
    echo "üßπ Czyszczenie starych backup√≥w..."
    
    if [ ! -d "$BACKUP_BASE" ]; then
        echo "‚úÖ Brak backup√≥w do wyczyszczenia"
        exit 0
    fi
    
    # Usu≈Ñ backupy starsze ni≈º 30 dni
    find "$BACKUP_BASE" -maxdepth 1 -type d -mtime +30 -exec rm -rf {} \;
    
    echo "‚ú® Backupy wyczyszczone!"
