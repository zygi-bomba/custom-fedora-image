# /etc/justfile

# Inicjalizacja ≈õrodowiska: klonuje repozytorium i bezpiecznie linkuje pliki
init-dots:
    #!/bin/bash
    set -euo pipefail

    # --- KONFIGURACJA ---
    DOTS_URL="https://github.com/zygi-bomba/dotfiles.git"
    DOTS_DIR="$HOME/dotfiles"
    BACKUP_DIR="$HOME/dotfiles_backup/$(date +%Y%m%d_%H%M%S)"

    echo "üöÄ Rozpoczynam inicjalizacjƒô dotfiles..."

    # 1. Przygotowanie repozytorium
    if [ ! -d "$DOTS_DIR" ]; then
        echo "üì• Klonujƒô repozytorium do $DOTS_DIR..."
        git clone "$DOTS_URL" "$DOTS_DIR"
    else
        echo "‚úÖ Repozytorium istnieje, aktualizujƒô..."
        git -C "$DOTS_DIR" pull
    fi

    # 2. Tworzenie niezbƒôdnych folder√≥w
    mkdir -p "$BACKUP_DIR"
    mkdir -p "$HOME/.config"

    cd "$DOTS_DIR"

    # 3. Inteligentne linkowanie z backupem
    # Szukamy folder√≥w, kt√≥re nie sƒÖ ukryte (omijamy .git)
    for pkg in */; do
        pkg=${pkg%/}
        [ "$pkg" == ".git" ] && continue
        
        echo "üì¶ Przetwarzam pakiet: $pkg"

        # Wykrywanie konflikt√≥w przez dry-run
        # Przekierowujemy stderr do stdout (2>&1), aby grep go widzia≈Ç
        CONFLICTS=$(stow -nv -t "$HOME" "$pkg" 2>&1 | grep "existing target is not owned by stow" | awk '{print $NF}' || true)

        if [ -n "$CONFLICTS" ]; then
            for conflict in $CONFLICTS; do
                FULL_PATH="$HOME/$conflict"
                if [ -e "$FULL_PATH" ] || [ -L "$FULL_PATH" ]; then
                    echo "‚ö†Ô∏è  Backup: $conflict -> $BACKUP_DIR/"
                    mkdir -p "$(dirname "$BACKUP_DIR/$conflict")"
                    mv "$FULL_PATH" "$BACKUP_DIR/$conflict"
                fi
            done
        fi

        # 4. Finalne wywo≈Çanie STOW
        # -R (restow) jest bezpieczniejsze przy ponownym uruchamianiu
        stow -R -v -t "$HOME" "$pkg"
    done

    echo "‚ú® Gotowe! Twoje dotfiles sƒÖ aktywne."
    echo "üìÅ Kopie zapasowe starych plik√≥w znajdziesz w: $BACKUP_DIR"
